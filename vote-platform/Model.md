# Модель данных системы голосования

# 1. BPMN диаграмма процесса

![BPMN Diagram](Models/IMGs/Main_BPMN.png)

# 2. UML диаграммы процесса
## 2.1 Use Case Diagram

### 2.1.1 Для Пользователя (User)
#### 2.1.1.1 Описание

| Прецедент | Описание |
|-----------|----------|
| Просматривать активные голосования | Пользователь видит список активных голосований, в которых он может участвовать.|
| Голосовать | Пользователь выбирает один или несколько вариантов. Система проверяет право голоса и уникальность.|
| Видеть результаты | После голосования или по окончании — пользователь видит итоги (в реальном времени).|


### 2.1.1.2 Диаграмма

![Use Case Diagram](Models/UML/Use_Case_Model.puml)

### 2.1.2 Для Администратора (Admin)
#### 2.1.2.1 Описание
| Прецедент | Описание |
|-----------|----------|
| Создать голосование | Начало процесса создания нового голосования. |
| Настроить параметры голосования | Указать: название, описание, время, варианты ответов, тип (один/несколько). |
| Запустить/остановить голосование | Управление жизненным циклом голосования. |
| Просматривать результаты в реальном времени | Наблюдение за ходом голосования с обновлением ≤ 4 сек. |
| Просматривать аудит-логи | Просмотр логов голосов (IP, время, метод доступа) для расследования. |

### 2.1.2.2 Диаграмма

### 2.1.3 Для Системы (System) — фоновые процессы
#### 2.1.3.1 Описание
| Прецедент | Описание |
|-----------|----------|
| Проверить право голоса | Проверка JWT-токена или email-токена на валидность и наличие доступа. |
| Заблокировать повторное голосование | По user_id и poll_id проверяется, голосовал ли пользователь. |
| Залогировать голос | Сохранение технических данных голоса (IP, User-Agent и т.д.) в целях аудита. |
| Обновить результаты в реальном времени | Асинхронное обновление счётчиков и рассылка через WebSocket. |



### 2.1.3.2 Диаграмма

## 2.2 Sequence diagram
### 2.2.1 Пользователь хочет проголосовать
![Sequence User Votes Diagram](Models/IMGs/Seq_User_Votes.png)

[Диаграмма в формате UML](Models/UML/Seq_User_Votes.puml)

### 2.2.2 API проверяет право голоса и дубли
![Sequence API Check Vote Diagram](Models/IMGs/Seq_Check_Vote.png)

[Диаграмма в формате UML](Models/UML/Seq_Check_Vote.puml)

### 2.2.3 API фиксирует голос (асинхронно)
![Sequence API Vote Diagram](Models/IMGs/Seq_API_Vote.png)

[Диаграмма в формате UML](Models/UML/Seq_API_Vote.puml)

Redis используется для:
Быстрой блокировки повторного голоса (на 10 минут — с запасом)
Мгновенного обновления счётчика в кэше
Rate limiting (например, не более 3 попыток в минуту)

### 2.2.4 Очередь и Worker обрабатывают голос
![Sequence Queue Worker Diagram](Models/IMGs/Seq_Queue_Vote.png)

[Диаграмма в формате UML](Models/UML/Seq_Queue_Vote.puml)

Почему асинхронно?
Чтобы не блокировать пользователя ожиданием записи в БД при высокой нагрузке.

### 2.2.5 Обновление результатов (в реальном времени)
![Sequence Update Results Diagram](Models/IMGs/Seq_Vote_Update.png)

[Диаграмма в формате UML](Models/UML/Seq_Vote_Update.puml)

Задержка:
Redis: < 100 мс
Очередь: < 500 мс
Worker + WS: < 1.5 с
Итого: ≤ 4 сек — требование выполнено

### 2.2.6 Администратор наблюдает за ходом голосования
![Sequence Admin Observe Diagram](Models/IMGs/Seq_Admin.png)

[Диаграмма в формате UML](Models/UML/Seq_Admin.puml)

# 3. Алгоритм голосования
1. Пользователь получает JWT-токен с правами голоса.
2. Пользователь выбирает варианты ответа и отправляет запрос на голосование.
3. Сервер проверяет права голоса и уникальность голосования.
4. Голос фиксируется в Vote и отправляется в очередь.
5. Worker обновляет PollResultCache и рассылает обновления через WebSocket.
6. Пользователь видит обновлённые результаты.

### 3.1 Sequence Diagram

Общая диаграмма последовательности: ![Sequence Diagram](Models/IMGs/sequence_diagram.png)

# 4. Схема базы данных (Сущности и их атрибуты)
## 4.1 User (Пользователь)
### 4.1.1 Краткое описание
Пользователь системы, который может участвовать в голосовании.
### 4.1.2 Атрибуты
| Поле | Тип данных | Описание |
|------|------------|----------|
| id | UUID / BIGINT (PK) | Уникальный идентификатор пользователя |
| email | VARCHAR(255), UNIQUE | Email пользователя (для проверки права голоса) |
| created_at | TIMESTAMP | Дата регистрации |
| last_login | TIMESTAMP | Последний вход (опционально) |
- [x] **Примечание:** Пользователь не аутентифицируется напрямую в системе — доступ проверяется через JWT или email-токен. Хранение email необходимо только для верификации права голоса.

## 4.2 Poll (Голосование)
### 4.2.1 Краткое описание
Описание голосования, которое может быть создано администратором.
### 4.2.2 Атрибуты
| Поле | Тип данных | Описание                                      |
|------|------------|-----------------------------------------------|
| id | UUID / BIGINT (PK) | Уникальный идентификатор голосования          |
| title | VARCHAR(255) | Название голосования                          |
| description | TEXT | Описание голосования                          |
| start_time | TIMESTAMP | Время начала голосования                      |
| end_time | TIMESTAMP | Время окончания голосования                   |
| is_active | BOOLEAN | Активно ли голосование (можно ли голосовать)  |
| allow_multiple_choices | BOOLEAN | Разрешён ли множественный выбор               |
| created_by | UUID (FK → User.id) | Администратор, создавший голосование          |
| created_at | TIMESTAMP | Дата создания                                 |
| updated_at | TIMESTAMP | Дата последнего обновления                    |
- [x] **Примечание:** Голосование может быть одно- или множественным выбором.

## 4.3 Option (Вариант ответа)
### 4.3.1 Краткое описание
Варианты ответов в рамках одного голосования.
### 4.3.2 Атрибуты
| Поле | Тип данных | Описание                                     |
|------|--------|--------------------------------|
| id | UUID (PK) | Уникальный идентификатор варианта ответа |
| poll_id | UUID (FK → Poll.id) | Голосование, к которому относится вариант |
| text | VARCHAR(255) | Текст варианта ответа|
|order|INT|Порядок отображения варианта ответа|
| created_at | TIMESTAMP | Дата создания варианта ответа |

## 4.4 Vote (Голос)
### 4.4.1 Краткое описание
Фиксирует факт голосования пользователем. Анонимный, но проверяемый.
### 4.4.2 Атрибуты
| Поле | Тип данных | Описание                                |
|------|------------|-----------------------------|
| id | UUID (PK) | Уникальный идентификатор голоса |
| poll_id | UUID (FK → Poll.id) | Голосование, к которому относится голос |
| option_id | UUID (FK → Option.id)	 | Выбранный вариант (может быть несколько записей на одно голосование при множественном выборе) |
| user_id | UUID (FK → User.id)	 | Кто проголосовал (для проверки дублей)|
| voted_at | TIMESTAMP | Время голосования |
| client_ip | INET | IP-адрес (для аудита)|
| user_agent | TEXT | User-Agent (для аудита)|
| auth_method | ENUM('email_token', 'jwt') | Способ проверки права голоса|
- [x] **Анонимность:** Пользователь не отображается в результатах. Данные голоса используются только для аудита и не публикуются.


## 4.5 PollResultCache (Кэш результатов)
### 4.5.1 Краткое описание
Для обеспечения обновления результатов в реальном времени (≤ 4 сек).
### 4.5.2 Атрибуты
| Поле | Тип данных | Описание                                |
|------|------------|-----------------------------------------|
| id | UUID (PK) | Уникальный идентификатор записи лога    |
| poll_id | UUID (FK → Poll.id) | Голосование, к которому относится голос |
| option_id | UUID (FK → Option.id) | Выбранный вариант                       |
| user_id | UUID (FK → User.id) | Пользователь, который проголосовал      |
| voted_at | TIMESTAMP | Время голосования                       |
| vote_count | BIGINT | Количество голосов                      |
| updated_at | TIMESTAMP | Время последнего обновления                              |

- [x] **Обновляется асинхронно** через message queue (например, Kafka, RabbitMQ) или stream processing (например, Redis Streams + worker).

ER диаграмма для базы данных:
![ER Diagram](Models/IMGs/ER_vote-platform_diagram.png)

Ссылка на ER диаграмму: [здесь](https://drawsql.app/teams/inetcoyote/diagrams/vote-platform)


# 5. Дополнительные компоненты системы
### 5.1 Проверка права голоса
При голосовании пользователь предоставляет:
* JWT-токен с подтверждением can_vote: true и email, или
* Одноразовый токен по email (сгенерированный системой).

Система проверяет:
* Активность голосования (Poll.is_active)
* Не голосовал ли уже пользователь (Vote с таким user_id и poll_id)
* Соответствие email в токене и в User.email

### 5.2 Реальное время (≤ 4 сек задержки)
Использование Redis или in-memory data store для кэширования счётчиков.

После каждого Vote:
* Запись в БД (PostgreSQL)
* Отправка события в очередь (Kafka/RabbitMQ)
* Worker обновляет PollResultCache и рассылает обновления через WebSocket или Server-Sent Events (SSE) подписчикам.

### 5.3 Аудит и безопасность
Все голоса логируются в таблицу Vote.

Логи включают:
* IP, User-Agent, время, метод аутентификации.
* Регулярный экспорт логов в SIEM или WORM-хранилище для защиты от подделки.


# 6. Индексы
### 6.1 Основные индексы (для ускорения поиска)
Пример на SQL:
```
CREATE INDEX idx_vote_poll_user ON Vote(poll_id, user_id); -- Проверка дублей
CREATE INDEX idx_vote_poll_option ON Vote(poll_id, option_id); -- Агрегация голосов
CREATE INDEX idx_poll_active ON Poll(is_active) WHERE is_active = true; -- Активные голосования
CREATE INDEX idx_vote_voted_at ON Vote(voted_at DESC); -- Аудит
```
# 7. Масштабируемость (до 100 000 голосов за 5–10 мин)
**Пиковая нагрузка:** до 100 000 голосов за 300 сек → ~333 голоса/сек.
**Рекомендации:**
* Горизонтальное масштабирование API-серверов (Kubernetes).
* Использование асинхронной записи голосов (через очередь).
* Разделение БД по нагрузке: OLTP (PostgreSQL) + OLAP (ClickHouse для аналитики).
* Redis для rate-limiting и блокировки повторных голосов.

# 8. Обработка ошибок
* **Проверка прав голоса:** Если права не подтверждены, возвращается ошибка 403.
* **Уникальность голосования:** Если пользователь уже голосовал, возвращается ошибка 409.
* **Аудит:** Все ошибки логируются с деталями запроса.
* **Обработка исключений:** Все исключения обрабатываются централизованно и возвращаются клиенту с кодом ошибки.
* **Валидация данных:** Все входящие данные проверяются на корректность.
* **Ограничение скорости:** Реализовано rate-limiting для предотвращения DDoS-атак.
* **Безопасность:** Все запросы проверяются на наличие JWT-токена и соответствие прав.

# 9. Тестирование
* **Unit-тесты:** Для каждого компонента системы.
* **Интеграционные тесты:** Проверка взаимодействия между компонентами.
* **Тестирование нагрузки:** Проверка системы на пиковую нагрузку.
* **Тестирование аудит:** Проверка корректности логирования.
* **Тестирование обработки ошибок:** Проверка корректности обработки исключений.
* **Тестирование валидации данных:** Проверка корректности валидации входящих данных.
* **Тестирование rate-limiting:** Проверка корректности ограничения скорости.
* **Тестирование безопасности:** Проверка корректности проверки прав голоса.
* **Тестирование масштабируемости:** Проверка корректности работы системы при высокой нагрузке.
* **Тестирование реального времени:** Проверка корректности работы системы при реальном времени.
* **Тестирование кэширования:** Проверка корректности работы кэша.
* **Тестирование аудита:** Проверка корректности логирования.

# 10. Архитектурные компоненты
| Компонент         | Технология |   Назначение |
|-------------------|----------|----------|
| Frontend          | React/Vue + WebSocket |   Интерфейс для пользователей и администраторов |
| API Gateway       | Express/NestJS/FastAPI |   Обработка HTTP-запросов, аутентификация |
| Auth Service      | JWT / Email Token |   Проверка права голоса |
| PostgreSQL        | OLTP-база данных |   Хранение голосов, пользователей, голосований |
| Redis             | In-memory store |   Кэш результатов, rate limiting, блокировка дублей |
| Message Queue     | Kafka / RabbitMQ	 |   Асинхронная обработка голосов|
| Worker            | Python/Node.js сервис	 |   Агрегация голосов, обновление кэша, аудит|
| WebSocket Server  | Socket.IO / SSE / Custom |   Рассылка обновлений в реальном времени |
| Audit Log Storage | S3 / ClickHouse / WORM |   Долгосрочное хранение логов аудита |

# 11. Мониторинг и логирование
| Компонент | Технология |   Назначение |
|-----------|----------|----------|
| Prometheus |   Мониторинг метрик |   CPU, RAM, запросы/сек, ошибки |
| Grafana   |   Визуализация метрик |   Графики, алерты |
| ELK Stack |   Логирование и поиск |   Запросы, ошибки, аудиты |
| Sentry    |   Мониторинг ошибок |   Трейсинг, уведомления |
| New Relic |   Мониторинг производительности |   Трейсинг, алерты |
| Datadog   |   Мониторинг метрик |   CPU, RAM, запросы/сек, ошибки |
| Honeycomb |   Мониторинг трафика |   Трейсинг, алерты |

# 12. Безопасность
| Компонент | Технология |   Назначение |
|-----------|----------|----------|
| HTTPS     |   Защита данных в транспорте |   Шифрование соединения |
| JWT       |   Аутентификация |   Безопасный токен доступа |
| OAuth2    |   Авторизация |   Проверка прав доступа |
| CORS      |   Защита от XSS |   Разрешение запросов с других доменов |
| CSRF      |   Защита от CSRF |   Защита от межсайтовой подделки запроса |
| XSS       |   Защита от XSS |   Защита от межсайтового скриптинга |
| SQLi      |   Защита от SQL-инъекций |   Защита от инъекций SQL |
| Rate Limiting |   Защита от DDoS |   Ограничение скорости запросов |
| Audit Logs |   Защита от подделки |   Логирование всех действий |
| WORM Storage |   Защита от подделки |   Долгосрочное хранение логов |

# 13. Swagger

| Эндпоинт | Описание | Swagger                                                                     |
|-----------|---------|--------------------------------|
| GET /polls/active   | возвращает массив активных опросов    | [Get_Pools - получение списка голосований](Models/Swagger/Get_Pools.yaml)   |
| POST /api/vote   | отправка голоса пользователя в опросе | [Post_Vote - отправка голоса](Models/Swagger/Post_Vote.yaml)                |

[Пример JSON ответа с перечнем возможных голосований](Models/JSON/Vote_Response.json)

[Пример JSON ответа с результатами голосования](Models/JSON/Vote_Results.json)

<!--
# 13. Документация
| Компонент | Технология |   Назначение |
|-----------|----------|----------|
| Swagger   |   API документация |   Описание всех API-методов |
| OpenAPI   |   API документация |   Описание всех API-методов |
| Postman   |   API тестирование |   Тестирование всех API-методов |
| Confluence|   Документация |   Описание архитектуры, процессов |
| Jira      |   Управление задачами |   Управление задачами |
| Trello    |   Управление задачами |   Управление задачами |
| Slack     |   Общение |   Общение между командами |
| Telegram  |   Общение |   Общение между командами |
| WhatsApp  |   Общение |   Общение между командами |
| Email     |   Общение |   Общение между командами |
| Phone     |   Общение |   Общение между командами |
| Video     |   Общение |   Общение между командами |
| Audio     |   Общение |   Общение между командами |
| Chat      |   Общение |   Общение между командами |
| Forum     |   Общение |   Общение между командами |

# 13. CI/CD
| Компонент | Технология |   Назначение |
|-----------|----------|----------|
| GitHub Actions |   CI/CD |   Автоматизация сборки и тестирования |
| Jenkins   |   CI/CD |   Автоматизация сборки и тестирования |
| GitLab CI |   CI/CD |   Автоматизация сборки и тестирования |
| CircleCI  |   CI/CD |   Автоматизация сборки и тестирования |
| Travis CI |   CI/CD |   Автоматизация сборки и тестирования |
| Git       |   Ветвление и слияние |   Управление версиями кода |
| Docker    |   Контейнеризация |   Пакетное развертывание приложений |
| Kubernetes|   Оркестрация контейнеров |   Автоматизация развертывания и масштабирования |
| Helm      |   Пакетный менеджер для Kubernetes |   Управление конфигурацией приложений |
| Terraform |   Инфраструктура как код |   Управление инфраструктурой |
| Ansible   |   Автоматизация конфигурации |   Управление конфигурацией серверов |
| Prometheus|   Мониторинг метрик |   Мониторинг производительности |
| Grafana   |   Визуализация метрик |   Визуализация метрик |
| ELK Stack |   Логирование и поиск |   Логирование и поиск |
| Sentry    |   Мониторинг ошибок |   Мониторинг ошибок |
| New Relic |   Мониторинг производительности |   Мониторинг производительности |
| Datadog   |   Мониторинг метрик |   Мониторинг метрик |
| Honeycomb |   Мониторинг трафика |   Мониторинг трафика |
-->
